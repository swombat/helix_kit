# Avatar Implementation - Simplified

## Summary

Add user avatars using Rails' Active Storage with S3. Display avatars with initials fallback. Simple upload/remove functionality.

## Implementation

### Step 1: Database Setup
```bash
rails active_storage:install
rails db:migrate
```

### Step 2: User Model
```ruby
# app/models/user.rb
class User < ApplicationRecord
  has_one_attached :avatar do |attachable|
    attachable.variant :thumb, resize_to_limit: [100, 100]
  end

  validates :avatar, content_type: ['image/png', 'image/jpeg', 'image/jpg'],
                     size: { less_than: 5.megabytes }

  def avatar_url
    rails_blob_url(avatar, only_path: true) if avatar.attached?
  end

  def initials
    full_name.present? ? full_name.split.map(&:first).first(2).join.upcase : email_address[0].upcase
  end
end
```

### Step 3: Controller
```ruby
# app/controllers/users_controller.rb
class UsersController < ApplicationController
  def update
    if Current.user.update(user_params)
      audit(:update, Current.user, changed_attributes: Current.user.saved_changes.keys)
      redirect_to edit_user_path, notice: "Settings updated"
    else
      render inertia: "user/edit", props: { errors: Current.user.errors }
    end
  end

  def destroy_avatar
    Current.user.avatar.purge
    audit(:remove_avatar, Current.user)
    redirect_to edit_user_path, notice: "Avatar removed"
  end

  private

  def user_params
    params.require(:user).permit(:first_name, :last_name, :timezone, :avatar)
  end
end
```

### Step 4: Routes
```ruby
# config/routes.rb
resource :user do
  delete :avatar, on: :member, to: "users#destroy_avatar"
end
```

### Step 5: Avatar Component
```svelte
<!-- app/frontend/lib/components/Avatar.svelte -->
<script>
  let { user, size = 'md' } = $props();
  
  const sizes = {
    sm: 'w-8 h-8',
    md: 'w-10 h-10', 
    lg: 'w-16 h-16'
  };
</script>

{#if user.avatar_url}
  <img src={user.avatar_url} alt="" class="rounded-full {sizes[size]}" />
{:else}
  <div class="rounded-full bg-primary text-white flex items-center justify-center {sizes[size]}">
    {user.initials}
  </div>
{/if}
```

### Step 6: Update Settings Form
```svelte
<!-- Add to UserSettingsForm.svelte -->
<script>
  import { router } from '@inertiajs/svelte';
  let fileInput;
  
  function uploadAvatar(e) {
    const file = e.target.files[0];
    if (file) {
      const formData = new FormData();
      formData.append('user[avatar]', file);
      router.post(userPath(), formData, { 
        method: 'patch',
        forceFormData: true 
      });
    }
  }
  
  function removeAvatar() {
    if (confirm('Remove avatar?')) {
      router.delete(`${userPath()}/avatar`);
    }
  }
</script>

<div class="flex items-center gap-4">
  <Avatar {user} size="lg" />
  <div>
    <input type="file" bind:this={fileInput} onchange={uploadAvatar} class="hidden" accept="image/*" />
    <button onclick={() => fileInput.click()} class="btn btn-sm">Change</button>
    {#if user.avatar_url}
      <button onclick={removeAvatar} class="btn btn-sm btn-error">Remove</button>
    {/if}
  </div>
</div>
```

### Step 7: Configure Storage
```yaml
# config/storage.yml
amazon:
  service: S3
  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
  region: us-east-1
  bucket: <%= Rails.application.credentials.dig(:aws, :bucket) %>
```

```ruby
# config/environments/production.rb
config.active_storage.service = :amazon

# Gemfile
gem "image_processing", "~> 1.12"
gem "aws-sdk-s3", require: false
```

## Testing

```ruby
# test/models/user_test.rb
test "avatar validations" do
  user = users(:one)
  
  # Valid avatar
  user.avatar.attach(io: file_fixture("avatar.jpg").open, filename: "avatar.jpg")
  assert user.valid?
  
  # Too large
  user.avatar.attach(io: StringIO.new("x" * 6.megabytes), filename: "large.jpg", content_type: "image/jpeg")
  assert_not user.valid?
end

test "initials" do
  user = User.new(email_address: "test@example.com", full_name: "John Doe")
  assert_equal "JD", user.initials
  
  user.full_name = nil
  assert_equal "T", user.initials
end
```

## Checklist

- [ ] Run Active Storage install and migration
- [ ] Add gems and bundle
- [ ] Update User model with attachment and methods
- [ ] Update controller with avatar in permitted params
- [ ] Add destroy_avatar action and route
- [ ] Create Avatar component
- [ ] Add upload/remove to settings form
- [ ] Configure S3 storage
- [ ] Add test fixtures and model tests
- [ ] Test upload, display, and removal

Done. Ship it.